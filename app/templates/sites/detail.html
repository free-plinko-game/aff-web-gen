{% extends "base.html" %}

{% block title %}{{ site.name }} — Affiliate Factory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 id="siteName" style="cursor:pointer" title="Click to rename" onclick="document.getElementById('siteNameForm').classList.remove('d-none');this.classList.add('d-none')">{{ site.name }}</h1>
    <form id="siteNameForm" class="d-none d-flex align-items-center gap-2" onsubmit="return renameSite(event)">
        <input type="text" class="form-control form-control-lg" id="siteNameInput" value="{{ site.name }}" style="max-width:400px">
        <button type="submit" class="btn btn-primary btn-sm">Save</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('siteNameForm').classList.add('d-none');document.getElementById('siteName').classList.remove('d-none')">Cancel</button>
    </form>
    {% set status_colors = {'draft': 'secondary', 'generating': 'info', 'generated': 'primary', 'building': 'info', 'built': 'primary', 'deploying': 'warning', 'deployed': 'success', 'failed': 'danger'} %}
    <span class="badge bg-{{ status_colors.get(site.status, 'secondary') }} fs-6" id="siteStatus">{{ site.status }}</span>
</div>

<!-- Rebuild Warning Banner (7.5) -->
{% if rebuild_needed %}
<div class="alert alert-warning d-flex align-items-center mb-4">
    <strong class="me-2">Rebuild needed:</strong>
    Content has changed since last build. Rebuild to update the static site, sitemap, and navigation.
    {% if site.status in ('generated', 'built') %}
    <form method="POST" action="{{ url_for('sites.build', site_id=site.id) }}" class="ms-3">
        <button type="submit" class="btn btn-sm btn-warning">Rebuild Now</button>
    </form>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="mb-4">
    {% set ungenerated = site.site_pages | rejectattr('is_generated') | list | length %}
    {% if site.status in ('draft', 'generated', 'built', 'deployed', 'failed') %}
    <form method="POST" action="{{ url_for('sites.generate', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-primary">
            {% if site.status == 'draft' %}Generate Content
            {% elif ungenerated %}Generate {{ ungenerated }} New Page{{ 's' if ungenerated != 1 }}
            {% else %}Regenerate All Content
            {% endif %}
        </button>
    </form>
    {% endif %}
    {% if site.status == 'generating' %}
    <button class="btn btn-info" disabled>Generating...</button>
    {% endif %}
    {% set has_content = site.site_pages | selectattr('is_generated') | list | length > 0 %}
    {% if has_content and site.status != 'generating' %}
    <form method="POST" action="{{ url_for('sites.generate_meta', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-outline-primary">Generate Meta Tags</button>
        <div class="form-check form-check-inline ms-1">
            <input class="form-check-input" type="checkbox" name="overwrite" id="metaOverwrite">
            <label class="form-check-label small text-muted" for="metaOverwrite">Overwrite existing</label>
        </div>
    </form>
    {% endif %}
    <form method="POST" action="{{ url_for('sites.build', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-success">
            {{ 'Rebuild Site' if site.built_at else 'Build Site' }}
        </button>
    </form>
    {% if site.status in ('built', 'deployed') and site.domain %}
    <form method="POST" action="{{ url_for('sites.deploy', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-warning">
            {{ 'Re-deploy' if site.status == 'deployed' else 'Deploy' }}
        </button>
    </form>
    {% endif %}
    {% if site.status == 'deployed' and site.current_version > 1 %}
    <form method="POST" action="{{ url_for('sites.rollback', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-outline-danger"
                onclick="return confirm('Roll back to the previous version?')">
            Rollback
        </button>
    </form>
    {% endif %}
    {% if site.status == 'deploying' %}
    <button class="btn btn-warning" disabled>Deploying...</button>
    {% endif %}
    {% if site.output_path %}
    <a href="{{ url_for('sites.preview', site_id=site.id) }}" target="_blank" class="btn btn-outline-info">
        Preview
    </a>
    {% endif %}
    <a href="{{ url_for('sites.add_page', site_id=site.id) }}" class="btn btn-outline-primary">
        Add Page
    </a>
    <form method="POST" action="{{ url_for('sites.delete_site', site_id=site.id) }}" class="d-inline float-end">
        <button type="submit" class="btn btn-outline-danger"
                onclick="return confirm('Permanently delete &quot;{{ site.name }}&quot; and all its pages? This cannot be undone.')">
            Delete Site
        </button>
    </form>
</div>

<!-- Progress Bar (shown during generation) -->
<div id="progressContainer" class="mb-4 {{ '' if site.status == 'generating' else 'd-none' }}">
    <div class="progress" style="height: 25px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar" style="width: 0%">
            <span id="progressText">0 / 0 pages</span>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><strong>Configuration</strong></div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr><th>GEO</th><td>{{ site.geo.name }} ({{ site.geo.code | upper }})</td></tr>
                    <tr><th>Vertical</th><td>{{ site.vertical.name }}</td></tr>
                    <tr>
                        <th>Domain</th>
                        <td>
                            {% if site.domain %}
                                {{ site.domain.domain }}
                                <span class="badge bg-{{ 'success' if site.domain.status == 'deployed' else 'info' }}">{{ site.domain.status }}</span>
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr><th>Created</th><td>{{ site.created_at.strftime('%Y-%m-%d %H:%M') if site.created_at else '' }}</td></tr>
                    <tr><th>Version</th><td>v{{ site.current_version }}</td></tr>
                    {% if site.built_at %}
                    <tr><th>Last Build</th><td>{{ site.built_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                    {% endif %}
                    {% if site.deployed_at %}
                    <tr><th>Deployed</th><td>{{ site.deployed_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                    {% endif %}
                    <tr>
                        <th>Freshness</th>
                        <td>
                            <form method="POST" action="{{ url_for('sites.update_freshness', site_id=site.id) }}" class="d-inline">
                                <div class="input-group input-group-sm" style="max-width: 200px;">
                                    <input type="number" name="threshold" class="form-control" value="{{ site.freshness_threshold_days or 30 }}" min="1" max="365">
                                    <span class="input-group-text">days</span>
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">Set</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <!-- Domain Assignment -->
        {% if not site.domain and available_domains %}
        <div class="card mb-3">
            <div class="card-header"><strong>Assign Domain</strong></div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('sites.assign_domain', site_id=site.id) }}">
                    <div class="input-group">
                        <select name="domain_id" class="form-select" required>
                            <option value="">Select a domain...</option>
                            {% for d in available_domains %}
                            <option value="{{ d.id }}">{{ d.domain }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#brandsCollapse" role="button" aria-expanded="false" aria-controls="brandsCollapse">
                    <strong>Brands ({{ site.site_brands | length }})</strong>
                    <small class="ms-1 text-muted">&#9662;</small>
                </a>
                <div>
                    <a href="{{ url_for('sites.manage_brands', site_id=site.id) }}" class="btn btn-sm btn-outline-primary">Manage</a>
                    <a href="{{ url_for('sites.brand_overrides', site_id=site.id) }}" class="btn btn-sm btn-outline-secondary">Overrides</a>
                </div>
            </div>
            <div class="collapse" id="brandsCollapse">
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr><th>Rank</th><th>Brand</th><th>Slug</th></tr>
                        </thead>
                        <tbody>
                            {% for sb in site.site_brands | sort(attribute='rank') %}
                            <tr>
                                <td>{{ sb.rank }}</td>
                                <td>{{ sb.brand.name }}</td>
                                <td><code>{{ sb.brand.slug }}</code></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- News Article Suggestions -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#newsCollapse" role="button" aria-expanded="false" aria-controls="newsCollapse">
            <strong>News Articles</strong>
            {% set news_count = site.site_pages | selectattr('page_type') | selectattr('page_type.slug', 'equalto', 'news-article') | list | length %}
            <span class="badge bg-secondary ms-1">{{ news_count }}</span>
            <small class="ms-1 text-muted">&#9662;</small>
        </a>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnSuggestNews" onclick="suggestNews()">
            Suggest 10 Articles
        </button>
    </div>
    <div class="collapse" id="newsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3" id="newsIntro">
                AI-generate timely news article topics based on your site's geo and vertical. Select the best ones to add as pages.
            </p>

            <div id="newsLoading" class="d-none text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">Generating news article suggestions...</span>
            </div>

            <div id="newsError" class="alert alert-danger d-none"></div>

            <div id="newsResults" class="d-none">
                <div id="newsList" class="mb-3"></div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" id="btnAddNews" onclick="addSelectedNews()">
                        Add Selected
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllNews(true)">Select All</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllNews(false)">Select None</button>
                </div>
            </div>

            <div id="newsAdded" class="alert alert-success d-none mt-3"></div>
        </div>
    </div>
</div>

<!-- Betting Tips Pipeline -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#tipsCollapse" role="button" aria-expanded="false" aria-controls="tipsCollapse">
            <strong>Betting Tips Pipeline</strong>
            {% set tips_count = site.site_pages | selectattr('page_type') | selectattr('page_type.slug', 'equalto', 'tips-article') | list | length %}
            <span class="badge bg-secondary ms-1">{{ tips_count }} articles</span>
            <small class="ms-1 text-muted">&#9662;</small>
        </a>
        <button type="button" class="btn btn-sm btn-outline-success" id="btnRunTips" onclick="runTipsPipeline()"
                {% if not site.tips_leagues %}disabled title="Configure leagues first"{% endif %}>
            Run Tips Pipeline
        </button>
    </div>
    <div class="collapse" id="tipsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3">
                Configure league IDs from <a href="https://www.api-football.com/documentation-v3#tag/Leagues" target="_blank" rel="noopener">API-Football</a>.
                The pipeline fetches upcoming fixtures (next 48h), generates AI match previews, and publishes them under <code>/tips/</code>.
            </p>

            <label for="tipsLeagues" class="form-label"><strong>Tips Leagues Config</strong> (JSON array)</label>
            <textarea id="tipsLeagues" class="form-control font-monospace mb-2" rows="5" placeholder='[{"league_id": 39, "name": "Premier League", "season": 2025}]'
            >{{ site.tips_leagues or '' }}</textarea>
            <div class="mb-3">
                <small class="text-muted">
                    Common IDs: 39 (Premier League), 140 (La Liga), 135 (Serie A), 78 (Bundesliga), 61 (Ligue 1), 2 (Champions League), 3 (Europa League)
                </small>
            </div>

            <div class="d-flex gap-2 align-items-center">
                <button type="button" class="btn btn-primary btn-sm" onclick="saveTipsLeagues()">Save Config</button>
                <span id="tipsConfigStatus" class="small"></span>
            </div>

            <div id="tipsPipelineStatus" class="mt-3 d-none"></div>
        </div>
    </div>
</div>

<!-- Comments System -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#commentsCollapse" role="button" aria-expanded="false" aria-controls="commentsCollapse">
            <strong>Comments</strong>
            {% set comment_count = [] %}
            <span class="badge bg-{{ 'success' if site.comments_enabled else 'secondary' }} ms-1" id="commentsEnabledBadge">{{ 'Enabled' if site.comments_enabled else 'Disabled' }}</span>
            <small class="ms-1 text-muted">&#9662;</small>
        </a>
        <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="commentsToggle" {{ 'checked' if site.comments_enabled else '' }} onchange="toggleComments()">
            <label class="form-check-label small" for="commentsToggle">Enable</label>
        </div>
    </div>
    <div class="collapse" id="commentsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3">
                Configure the comments API URL and generate AI personas to seed discussion threads on article pages.
            </p>

            <label for="commentsApiUrl" class="form-label"><strong>Comments API URL</strong></label>
            <div class="input-group mb-3">
                <input type="text" id="commentsApiUrl" class="form-control" placeholder="https://your-server:8080"
                       value="{{ site.comments_api_url or '' }}">
                <button class="btn btn-primary btn-sm" onclick="saveCommentsConfig()">Save</button>
            </div>
            <small class="text-muted d-block mb-3">The base URL of your Flask server (where static sites will fetch comments from).</small>

            <hr>

            <div class="d-flex align-items-center gap-2 mb-3">
                <strong>Personas:</strong>
                <span id="personaCount" class="badge bg-secondary">-</span>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <input type="number" id="personaGenCount" class="form-control form-control-sm" value="10" min="1" max="30" style="width:70px">
                    <button class="btn btn-sm btn-outline-success" id="btnGenPersonas" onclick="generateCommentPersonas()">Generate Personas</button>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 mb-2">
                <button class="btn btn-sm btn-outline-primary" id="btnSeedAll" onclick="seedAllComments()">Seed All Pages</button>
                <small class="text-muted">Seeds comments on all article pages that don't have any yet.</small>
            </div>

            <div id="commentsStatus" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- Authors & E-E-A-T -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#authorsCollapse" role="button" aria-expanded="false" aria-controls="authorsCollapse">
            <strong>Authors</strong>
            <span class="badge bg-secondary ms-1" id="authorCount">0</span>
            <small class="ms-1 text-muted">&#9662;</small>
        </a>
        <div>
            <button type="button" class="btn btn-sm btn-outline-success" id="btnGenerateAuthors" onclick="generateAuthors()">
                Generate Authors
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAddAuthorForm()">
                Add Author
            </button>
        </div>
    </div>
    <div class="collapse" id="authorsCollapse">
        <div class="card-body">
            <!-- Default author selector -->
            <div class="mb-3 d-flex align-items-center gap-2">
                <label for="defaultAuthor" class="form-label mb-0"><strong>Default Author:</strong></label>
                <select id="defaultAuthor" class="form-select form-select-sm" style="max-width:250px" onchange="setDefaultAuthor(this.value)">
                    <option value="">None</option>
                </select>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="assignAuthorBulk()">
                    Assign to Unassigned Pages
                </button>
            </div>

            <!-- AI Generation preview area -->
            <div id="authorGenLoading" class="d-none text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">Generating author personas...</span>
            </div>
            <div id="authorGenPreview" class="d-none mb-3"></div>

            <!-- Add/Edit form (hidden by default) -->
            <div id="authorForm" class="d-none border rounded p-3 mb-3 bg-light">
                <h6 id="authorFormTitle">Add Author</h6>
                <input type="hidden" id="authorFormId" value="">
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label small">Name *</label>
                        <input type="text" id="authorName" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Slug</label>
                        <input type="text" id="authorSlug" class="form-control form-control-sm" placeholder="auto-generated">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Role</label>
                        <input type="text" id="authorRole" class="form-control form-control-sm" placeholder="Senior Betting Analyst">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Active</label>
                        <select id="authorActive" class="form-select form-select-sm">
                            <option value="1" selected>Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Short Bio (byline)</label>
                    <input type="text" id="authorShortBio" class="form-control form-control-sm" maxlength="500" placeholder="One-sentence bio for article bylines">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Full Bio (HTML)</label>
                    <textarea id="authorBio" class="form-control form-control-sm" rows="4" placeholder="2-3 paragraph bio with <p> tags"></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Expertise (comma-separated)</label>
                    <input type="text" id="authorExpertise" class="form-control form-control-sm" placeholder="Premier League, Odds Analysis, Football Betting">
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveAuthor()">Save</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="hideAuthorForm()">Cancel</button>
                    <span id="authorFormStatus" class="small align-self-center"></span>
                </div>
            </div>

            <!-- Author list -->
            <div id="authorList"></div>
            <div id="authorStatus" class="mt-2"></div>
        </div>
    </div>
</div>

<!-- Dead Internal Links -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Dead Internal Links</strong>
        <button type="button" class="btn btn-sm btn-outline-warning" id="btnSweepLinks" onclick="sweepLinks('report')">
            Scan for Dead Links
        </button>
    </div>
    <div id="sweepResults" class="d-none">
        <div class="card-body">
            <div id="sweepStatus"></div>
            <table id="sweepTable" class="table table-sm d-none mb-2">
                <thead><tr><th>Page</th><th>Dead Link</th><th>Link Text</th></tr></thead>
                <tbody></tbody>
            </table>
            <button type="button" class="btn btn-sm btn-danger d-none" id="btnFixLinks" onclick="sweepLinks('fix')">
                Fix All Dead Links
            </button>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-sitemap" type="button">
            Site Map
            <span class="badge bg-secondary ms-1">{{ site.site_pages | length }}</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-menu-order" type="button">
            Menu Order
        </button>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('sites.menu', site_id=site.id) }}">
            Menu Config
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('sites.cta_table_list', site_id=site.id) }}">
            CTA Tables
        </a>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-robots" type="button">
            robots.txt
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- Sitemap Tab (7.3) -->
    <div class="tab-pane fade show active" id="tab-sitemap">
        {% set generated_count = site.site_pages | selectattr('is_generated') | list | length %}
        {% set pending_count = site.site_pages | length - generated_count %}
        <p class="text-muted mb-3">
            {{ site.site_pages | length }} pages ({{ generated_count }} generated, {{ pending_count }} pending{% if stale_count %}, <strong class="text-warning">{{ stale_count }} stale</strong>{% endif %})
        </p>

        <table class="table table-sm">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Page Type</th>
                    <th>Status</th>
                    <th>Freshness</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for page in site.site_pages %}
                {% set url = page_url(page) %}
                {% set freshness = page_freshness(page) %}
                <tr>
                    <td>
                        <code>
                        {% if site.domain %}
                            https://{{ site.domain.domain }}{{ url }}
                        {% else %}
                            {{ url }}
                        {% endif %}
                        </code>
                    </td>
                    <td><span class="badge bg-secondary">{{ page.page_type.name }}</span></td>
                    <td>
                        {% if not page.is_generated %}
                            <span class="badge bg-light text-dark">Not Generated</span>
                        {% elif site.built_at and page.generated_at and page.generated_at > site.built_at %}
                            <span class="badge bg-warning text-dark">Needs Rebuild</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% elif not site.built_at %}
                            <span class="badge bg-info">Generated</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') if page.generated_at else '' }}</small>
                        {% else %}
                            <span class="badge bg-success">Built</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') if page.generated_at else '' }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if freshness is none %}
                            <span class="text-muted">—</span>
                        {% elif freshness.stale %}
                            <span class="badge bg-danger bg-opacity-75">Stale ({{ freshness.days }}d)</span>
                        {% else %}
                            <span class="badge bg-success bg-opacity-75">Fresh ({{ freshness.days }}d)</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('sites.edit_page', site_id=site.id, page_id=page.id) }}"
                           class="btn btn-sm btn-outline-primary">Edit</a>
                        {% if page.is_generated and site.status != 'generating' %}
                        <form method="POST" action="{{ url_for('sites.regenerate_page', site_id=site.id, page_id=page.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Regenerate</button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('sites.delete_page', site_id=site.id, page_id=page.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Delete this page? This cannot be undone.')">Delete</button>
                        </form>
                        {% if page.is_generated and site.output_path %}
                        <a href="{{ url_for('sites.preview', site_id=site.id, filename=url[1:]) }}"
                           target="_blank" class="btn btn-sm btn-outline-info">Preview</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Menu Order Tab -->
    <div class="tab-pane fade" id="tab-menu-order">
        {% set nav_pages = site.site_pages | selectattr('show_in_nav') | list | sort(attribute='nav_order') %}
        {% set top_pages = nav_pages | rejectattr('nav_parent_id') | list %}
        {% if top_pages %}
        <p class="text-muted mb-3">Drag to reorder nav items. Children are shown indented under their parent. Changes save instantly.</p>
        <div id="menuOrderList">
            {% for page in top_pages %}
            {% if page.page_type.slug != 'homepage' %}
            <div class="menu-order-row d-flex align-items-center border rounded mb-2 p-2"
                 data-page-id="{{ page.id }}">
                <span class="drag-handle me-2 text-muted" style="cursor:grab; font-size:1.2rem;">&#9776;</span>
                <strong class="me-2">{{ page.nav_label or page.title }}</strong>
                <span class="badge bg-secondary">{{ page.page_type.name }}</span>
            </div>
            {% set children = nav_pages | selectattr('nav_parent_id', 'equalto', page.id) | list | sort(attribute='nav_order') %}
            {% if children %}
            <div class="menu-order-children ms-4 mb-2" id="children-{{ page.id }}">
                {% for child in children %}
                <div class="menu-order-row d-flex align-items-center border rounded mb-1 p-2 bg-light"
                     data-page-id="{{ child.id }}">
                    <span class="drag-handle me-2 text-muted" style="cursor:grab; font-size:1.2rem;">&#9776;</span>
                    <span class="text-muted me-1">&#8627;</span>
                    {{ child.nav_label or child.title }}
                    <span class="badge bg-secondary ms-2">{{ child.page_type.name }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>
        <div id="menuOrderStatus" class="mt-2"></div>
        {% else %}
        <p class="text-muted">No pages are set to show in the nav bar. Go to <a href="{{ url_for('sites.menu', site_id=site.id) }}">Menu Config</a> to enable pages in the nav.</p>
        {% endif %}
    </div>

    <!-- Robots.txt Tab (7.4) -->
    <div class="tab-pane fade" id="tab-robots">
        <form id="robotsForm">
            <div class="mb-3">
                <label for="robotsTxt" class="form-label">
                    {% if site.custom_robots_txt %}
                        <strong>Custom robots.txt</strong> (will be used verbatim on next build)
                    {% else %}
                        <strong>Default robots.txt</strong> (auto-generated from template)
                    {% endif %}
                </label>
                <textarea id="robotsTxt" class="form-control font-monospace" rows="10"
                >{{ site.custom_robots_txt or default_robots_txt }}</textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveRobotsTxt()">Save Custom robots.txt</button>
            {% if site.custom_robots_txt %}
            <button type="button" class="btn btn-outline-secondary" onclick="resetRobotsTxt()">Reset to Default</button>
            {% endif %}
            <small class="text-muted ms-2">Changes take effect on next build.</small>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<style>
.sortable-ghost { opacity: 0.4; background: #e9ecef !important; }
.drag-handle:hover { color: #333 !important; }
</style>
{% if site.status == 'generating' %}
<script>
(function pollProgress() {
    fetch('{{ url_for("api.generation_status", site_id=site.id) }}')
        .then(r => r.json())
        .then(data => {
            const pct = data.total_pages > 0
                ? Math.round((data.generated_pages / data.total_pages) * 100)
                : 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').textContent =
                data.generated_pages + ' / ' + data.total_pages + ' pages';
            document.getElementById('siteStatus').textContent = data.status;

            if (data.status === 'generating') {
                setTimeout(pollProgress, 2000);
            } else {
                window.location.reload();
            }
        })
        .catch(() => setTimeout(pollProgress, 3000));
})();
</script>
{% endif %}
<script>
function saveRobotsTxt() {
    const content = document.getElementById('robotsTxt').value;
    fetch('{{ url_for("api.save_robots_txt", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: content})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
    });
}

function resetRobotsTxt() {
    if (!confirm('Reset to default robots.txt? Your custom version will be removed.')) return;
    fetch('{{ url_for("api.save_robots_txt", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: null})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to reset: ' + (data.error || 'Unknown error'));
        }
    });
}

function renameSite(e) {
    e.preventDefault();
    const name = document.getElementById('siteNameInput').value.trim();
    if (!name) return false;
    fetch('{{ url_for("api.rename_site", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to rename: ' + (data.error || 'Unknown error'));
        }
    });
    return false;
}

/* --- Menu Order (drag-and-drop) --- */
function initMenuOrder() {
    var list = document.getElementById('menuOrderList');
    if (!list) return;

    // Make top-level sortable
    new Sortable(list, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        draggable: '.menu-order-row',
        onEnd: saveMenuOrder,
    });

    // Make each children group sortable
    document.querySelectorAll('.menu-order-children').forEach(function(el) {
        new Sortable(el, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            draggable: '.menu-order-row',
            onEnd: saveMenuOrder,
        });
    });
}

function saveMenuOrder() {
    var order = [];
    var position = 0;

    // Walk the top-level list: for each top-level row, then its children container
    var list = document.getElementById('menuOrderList');
    if (!list) return;

    list.querySelectorAll(':scope > .menu-order-row, :scope > .menu-order-children > .menu-order-row').forEach(function(row) {
        order.push({
            page_id: parseInt(row.dataset.pageId),
            nav_order: position * 10,
        });
        position++;
    });

    var status = document.getElementById('menuOrderStatus');
    status.innerHTML = '<small class="text-muted">Saving...</small>';

    fetch('{{ url_for("api.save_menu_order", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({order: order}),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            status.innerHTML = '<small class="text-success">Saved</small>';
        } else {
            status.innerHTML = '<small class="text-danger">Error: ' + (data.error || 'Unknown') + '</small>';
        }
        setTimeout(function() { status.innerHTML = ''; }, 2000);
    })
    .catch(function(err) {
        status.innerHTML = '<small class="text-danger">Failed: ' + err.message + '</small>';
    });
}

/* --- News Article Suggestions --- */
let _newsSuggestions = [];

function suggestNews() {
    const btn = document.getElementById('btnSuggestNews');
    const loading = document.getElementById('newsLoading');
    const error = document.getElementById('newsError');
    const results = document.getElementById('newsResults');
    const collapse = document.getElementById('newsCollapse');

    // Expand the collapse if closed
    const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
    bsCollapse.show();

    btn.disabled = true;
    loading.classList.remove('d-none');
    error.classList.add('d-none');
    results.classList.add('d-none');

    fetch('{{ url_for("api.suggest_news", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        loading.classList.add('d-none');
        btn.disabled = false;

        if (data.error) {
            error.textContent = data.error;
            error.classList.remove('d-none');
            return;
        }

        _newsSuggestions = data.suggestions || [];
        if (_newsSuggestions.length === 0) {
            error.textContent = 'No suggestions returned. Try again.';
            error.classList.remove('d-none');
            return;
        }

        const list = document.getElementById('newsList');
        list.innerHTML = '';
        _newsSuggestions.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2 p-2 border rounded';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" id="news-${i}" checked>
                <label class="form-check-label" for="news-${i}">
                    <strong>${s.topic}</strong>
                    <br><small class="text-muted">${s.angle || ''}</small>
                    <br><small class="text-info">${s.reason || ''}</small>
                </label>
            `;
            list.appendChild(div);
        });

        results.classList.remove('d-none');
    })
    .catch(err => {
        loading.classList.add('d-none');
        btn.disabled = false;
        error.textContent = 'Request failed: ' + err.message;
        error.classList.remove('d-none');
    });
}

function toggleAllNews(checked) {
    document.querySelectorAll('#newsList input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
    });
}

function addSelectedNews() {
    const pages = [];
    const checkboxes = document.querySelectorAll('#newsList input[type="checkbox"]');
    checkboxes.forEach((cb, i) => {
        if (cb.checked && _newsSuggestions[i]) {
            pages.push({
                page_type: 'news-article',
                evergreen_topic: _newsSuggestions[i].topic,
            });
        }
    });

    if (pages.length === 0) {
        alert('Select at least one article to add.');
        return;
    }

    // Auto-include news landing page if not already present
    {% set has_news_landing = site.site_pages | selectattr('page_type') | selectattr('page_type.slug', 'equalto', 'news') | list | length > 0 %}
    {% if not has_news_landing %}
    pages.unshift({page_type: 'news'});
    {% endif %}

    const btn = document.getElementById('btnAddNews');
    btn.disabled = true;
    btn.textContent = 'Adding...';

    fetch('{{ url_for("sites.add_suggested_pages", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pages: pages}),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Add Selected';

        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        const msg = document.getElementById('newsAdded');
        msg.textContent = `Added ${data.added} page(s)` + (data.skipped ? ` (${data.skipped} skipped)` : '') + '. Reloading...';
        msg.classList.remove('d-none');
        document.getElementById('newsResults').classList.add('d-none');

        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Add Selected';
        alert('Request failed: ' + err.message);
    });
}

/* --- Betting Tips Pipeline --- */
function saveTipsLeagues() {
    const raw = document.getElementById('tipsLeagues').value.trim();
    const status = document.getElementById('tipsConfigStatus');
    let leagues = null;

    if (raw) {
        try {
            leagues = JSON.parse(raw);
            if (!Array.isArray(leagues)) {
                status.innerHTML = '<span class="text-danger">Must be a JSON array</span>';
                return;
            }
        } catch (e) {
            status.innerHTML = '<span class="text-danger">Invalid JSON: ' + e.message + '</span>';
            return;
        }
    }

    status.innerHTML = '<span class="text-muted">Saving...</span>';

    fetch('{{ url_for("api.save_tips_leagues", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({leagues: leagues}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            status.innerHTML = '<span class="text-success">Saved</span>';
            // Enable run button if we have leagues
            document.getElementById('btnRunTips').disabled = !leagues || leagues.length === 0;
            setTimeout(() => { status.innerHTML = ''; }, 2000);
        } else {
            status.innerHTML = '<span class="text-danger">' + (data.error || 'Failed') + '</span>';
        }
    })
    .catch(err => {
        status.innerHTML = '<span class="text-danger">Error: ' + err.message + '</span>';
    });
}

function runTipsPipeline() {
    const btn = document.getElementById('btnRunTips');
    const status = document.getElementById('tipsPipelineStatus');

    btn.disabled = true;
    btn.textContent = 'Running...';
    status.classList.remove('d-none');
    status.innerHTML = '<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2"></div>Tips pipeline running in background. New articles will appear when finished.</div>';

    fetch('{{ url_for("api.run_tips_pipeline", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            status.innerHTML = '<div class="alert alert-success">Pipeline started! New tip articles will appear shortly. Refresh the page in a minute to see results.</div>';
            setTimeout(() => window.location.reload(), 30000);
        } else {
            status.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Failed to start pipeline') + '</div>';
            btn.disabled = false;
            btn.textContent = 'Run Tips Pipeline';
        }
    })
    .catch(err => {
        status.innerHTML = '<div class="alert alert-danger">Request failed: ' + err.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Run Tips Pipeline';
    });
}

/* --- Comments System --- */
function toggleComments() {
    fetch('{{ url_for("api.toggle_comments", site_id=site.id) }}', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        const badge = document.getElementById('commentsEnabledBadge');
        if (data.enabled) {
            badge.textContent = 'Enabled';
            badge.className = 'badge bg-success ms-1';
        } else {
            badge.textContent = 'Disabled';
            badge.className = 'badge bg-secondary ms-1';
        }
    });
}

function saveCommentsConfig() {
    const url = document.getElementById('commentsApiUrl').value.trim();
    const status = document.getElementById('commentsStatus');
    fetch('{{ url_for("api.save_comments_config", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({comments_api_url: url}),
    })
    .then(r => r.json())
    .then(data => {
        status.innerHTML = data.success
            ? '<div class="alert alert-success py-1 px-2 small">API URL saved.</div>'
            : '<div class="alert alert-danger py-1 px-2 small">Error saving.</div>';
        setTimeout(() => status.innerHTML = '', 3000);
    });
}

function generateCommentPersonas() {
    const btn = document.getElementById('btnGenPersonas');
    const count = parseInt(document.getElementById('personaGenCount').value) || 10;
    const status = document.getElementById('commentsStatus');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    status.innerHTML = '<div class="alert alert-info py-1 px-2 small"><div class="spinner-border spinner-border-sm me-1"></div>Generating personas...</div>';

    fetch('{{ url_for("api.generate_personas_endpoint", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({count: count}),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Generate Personas';
        if (data.success) {
            status.innerHTML = '<div class="alert alert-success py-1 px-2 small">Created ' + data.count + ' personas.</div>';
            loadPersonaCount();
        } else {
            status.innerHTML = '<div class="alert alert-danger py-1 px-2 small">' + (data.error || 'Failed') + '</div>';
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Generate Personas';
        status.innerHTML = '<div class="alert alert-danger py-1 px-2 small">' + err.message + '</div>';
    });
}

function seedAllComments() {
    const btn = document.getElementById('btnSeedAll');
    const status = document.getElementById('commentsStatus');
    btn.disabled = true;
    btn.textContent = 'Seeding...';
    status.innerHTML = '<div class="alert alert-info py-1 px-2 small"><div class="spinner-border spinner-border-sm me-1"></div>Seeding comments on all pages...</div>';

    fetch('{{ url_for("api.seed_all_comments", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Seed All Pages';
        if (data.success) {
            status.innerHTML = '<div class="alert alert-success py-1 px-2 small">Seeded ' + data.total_comments + ' comments across ' + data.seeded_pages + ' pages.</div>';
        } else {
            status.innerHTML = '<div class="alert alert-danger py-1 px-2 small">' + (data.error || 'Failed') + '</div>';
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Seed All Pages';
        status.innerHTML = '<div class="alert alert-danger py-1 px-2 small">' + err.message + '</div>';
    });
}

function loadPersonaCount() {
    // Simple inline count via the comments API count endpoint isn't available for personas,
    // so just reload the badge on next page load. For now we do a fetch.
    // This is a placeholder — the count badge updates on page reload.
}

/* --- Dead Link Sweep --- */
function sweepLinks(mode) {
    const btn = document.getElementById('btnSweepLinks');
    const fixBtn = document.getElementById('btnFixLinks');
    const results = document.getElementById('sweepResults');
    const status = document.getElementById('sweepStatus');
    const table = document.getElementById('sweepTable');
    const tbody = table.querySelector('tbody');

    btn.disabled = true;
    btn.textContent = mode === 'fix' ? 'Fixing...' : 'Scanning...';
    results.classList.remove('d-none');
    fixBtn.classList.add('d-none');
    table.classList.add('d-none');
    status.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Working...';

    fetch('{{ url_for("api.sweep_links", site_id=site.id) }}?mode=' + mode, {
        method: 'POST',
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Scan for Dead Links';

        if (mode === 'fix') {
            status.innerHTML = '<div class="alert alert-success mb-0">Fixed ' + data.fixed + ' dead link(s) across ' + data.pages_updated + ' page(s).</div>';
            fixBtn.classList.add('d-none');
            table.classList.add('d-none');
            return;
        }

        if (data.count === 0) {
            status.innerHTML = '<div class="alert alert-success mb-0">No dead links found.</div>';
            return;
        }

        status.innerHTML = '<div class="alert alert-warning">Found ' + data.count + ' dead link(s) across ' + new Set(data.dead_links.map(d => d.page_id)).size + ' page(s).</div>';
        tbody.innerHTML = '';
        data.dead_links.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>' + d.page_title + '</td><td><code>' + d.link_url + '</code></td><td>' + d.link_text + '</td>';
            tbody.appendChild(tr);
        });
        table.classList.remove('d-none');
        fixBtn.classList.remove('d-none');
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Scan for Dead Links';
        status.innerHTML = '<div class="alert alert-danger">Error: ' + err.message + '</div>';
    });
}

/* --- Authors & E-E-A-T --- */
const _authorApiBase = '{{ url_for("api.list_authors", site_id=site.id) }}';
let _authors = [];
let _defaultAuthorId = null;

function loadAuthors() {
    fetch(_authorApiBase)
    .then(r => r.json())
    .then(data => {
        _authors = data.authors || [];
        _defaultAuthorId = data.default_author_id;
        renderAuthorList();
    });
}

function renderAuthorList() {
    document.getElementById('authorCount').textContent = _authors.length;
    const list = document.getElementById('authorList');
    const sel = document.getElementById('defaultAuthor');

    // Update default author dropdown
    sel.innerHTML = '<option value="">None</option>';
    _authors.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name + (a.role ? ' — ' + a.role : '');
        if (a.id === _defaultAuthorId) opt.selected = true;
        sel.appendChild(opt);
    });

    if (_authors.length === 0) {
        list.innerHTML = '<p class="text-muted mb-0">No authors yet. Click "Generate Authors" to create AI personas or "Add Author" to add manually.</p>';
        return;
    }

    let html = '<div class="list-group">';
    _authors.forEach(a => {
        const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
        const avatarHtml = a.avatar_filename
            ? `<img src="/uploads/avatars/${a.avatar_filename}" class="rounded-circle" width="36" height="36" style="object-fit:cover">`
            : `<span class="rounded-circle d-inline-flex align-items-center justify-content-center text-white" style="width:36px;height:36px;font-size:0.8rem;background:hsl(${hashCode(a.name) % 360},45%,45%)">${initials}</span>`;
        html += `
        <div class="list-group-item d-flex align-items-center gap-2">
            ${avatarHtml}
            <div class="flex-grow-1">
                <strong>${a.name}</strong>
                ${a.role ? '<small class="text-muted ms-1">' + a.role + '</small>' : ''}
                <br><small class="text-muted">${a.article_count} article${a.article_count !== 1 ? 's' : ''}${!a.is_active ? ' · <span class="text-danger">Inactive</span>' : ''}</small>
            </div>
            <div class="btn-group btn-group-sm">
                <label class="btn btn-outline-secondary btn-sm mb-0" title="Upload avatar">
                    <input type="file" accept="image/*" class="d-none" onchange="uploadAvatar(${a.id}, this.files[0])">&#128247;
                </label>
                <button class="btn btn-outline-primary btn-sm" onclick="editAuthor(${a.id})">Edit</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteAuthor(${a.id})">Delete</button>
            </div>
        </div>`;
    });
    html += '</div>';
    list.innerHTML = html;
}

function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return Math.abs(hash);
}

function showAddAuthorForm() {
    document.getElementById('authorFormTitle').textContent = 'Add Author';
    document.getElementById('authorFormId').value = '';
    document.getElementById('authorName').value = '';
    document.getElementById('authorSlug').value = '';
    document.getElementById('authorRole').value = '';
    document.getElementById('authorShortBio').value = '';
    document.getElementById('authorBio').value = '';
    document.getElementById('authorExpertise').value = '';
    document.getElementById('authorActive').value = '1';
    document.getElementById('authorForm').classList.remove('d-none');
}

function hideAuthorForm() {
    document.getElementById('authorForm').classList.add('d-none');
    document.getElementById('authorFormStatus').innerHTML = '';
}

function editAuthor(id) {
    const a = _authors.find(x => x.id === id);
    if (!a) return;
    document.getElementById('authorFormTitle').textContent = 'Edit Author';
    document.getElementById('authorFormId').value = a.id;
    document.getElementById('authorName').value = a.name;
    document.getElementById('authorSlug').value = a.slug;
    document.getElementById('authorRole').value = a.role || '';
    document.getElementById('authorShortBio').value = a.short_bio || '';
    document.getElementById('authorBio').value = a.bio || '';
    document.getElementById('authorExpertise').value = (a.expertise || []).join(', ');
    document.getElementById('authorActive').value = a.is_active ? '1' : '0';
    document.getElementById('authorForm').classList.remove('d-none');
}

function saveAuthor() {
    const id = document.getElementById('authorFormId').value;
    const status = document.getElementById('authorFormStatus');
    const expertise_raw = document.getElementById('authorExpertise').value.trim();

    const payload = {
        name: document.getElementById('authorName').value.trim(),
        slug: document.getElementById('authorSlug').value.trim(),
        role: document.getElementById('authorRole').value.trim(),
        short_bio: document.getElementById('authorShortBio').value.trim(),
        bio: document.getElementById('authorBio').value.trim(),
        expertise: expertise_raw ? expertise_raw.split(',').map(s => s.trim()).filter(Boolean) : [],
        is_active: document.getElementById('authorActive').value === '1',
    };

    if (!payload.name) {
        status.innerHTML = '<span class="text-danger">Name is required</span>';
        return;
    }

    status.innerHTML = '<span class="text-muted">Saving...</span>';

    const url = id ? `${_authorApiBase}/${id}` : _authorApiBase;
    const method = id ? 'PUT' : 'POST';

    fetch(url, {method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)})
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            hideAuthorForm();
            loadAuthors();
        } else {
            status.innerHTML = '<span class="text-danger">' + (data.error || 'Failed') + '</span>';
        }
    })
    .catch(err => {
        status.innerHTML = '<span class="text-danger">Error: ' + err.message + '</span>';
    });
}

function deleteAuthor(id) {
    const a = _authors.find(x => x.id === id);
    if (!confirm(`Delete author "${a ? a.name : id}"? Their bylines will be removed from all pages.`)) return;

    fetch(`${_authorApiBase}/${id}`, {method: 'DELETE'})
    .then(r => r.json())
    .then(data => {
        if (data.success) loadAuthors();
        else alert(data.error || 'Failed to delete');
    });
}

function uploadAvatar(authorId, file) {
    if (!file) return;
    const fd = new FormData();
    fd.append('avatar', file);

    fetch(`${_authorApiBase}/${authorId}/avatar`, {method: 'POST', body: fd})
    .then(r => r.json())
    .then(data => {
        if (data.success) loadAuthors();
        else alert(data.error || 'Upload failed');
    });
}

function setDefaultAuthor(authorId) {
    fetch('{{ url_for("api.set_default_author", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({author_id: authorId ? parseInt(authorId) : null}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            _defaultAuthorId = authorId ? parseInt(authorId) : null;
            const s = document.getElementById('authorStatus');
            s.innerHTML = '<small class="text-success">Default author updated</small>';
            setTimeout(() => { s.innerHTML = ''; }, 2000);
        }
    });
}

function assignAuthorBulk() {
    const authorId = document.getElementById('defaultAuthor').value;
    if (!authorId) {
        alert('Select a default author first.');
        return;
    }
    if (!confirm('Assign this author to all pages that don\'t have one?')) return;

    fetch('{{ url_for("api.assign_author_bulk", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({author_id: parseInt(authorId)}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const s = document.getElementById('authorStatus');
            s.innerHTML = `<small class="text-success">Assigned to ${data.updated} page(s)</small>`;
            setTimeout(() => { s.innerHTML = ''; }, 3000);
        } else {
            alert(data.error || 'Failed');
        }
    });
}

function generateAuthors() {
    const btn = document.getElementById('btnGenerateAuthors');
    const loading = document.getElementById('authorGenLoading');
    const preview = document.getElementById('authorGenPreview');
    const collapse = document.getElementById('authorsCollapse');

    new bootstrap.Collapse(collapse, {toggle: false}).show();

    btn.disabled = true;
    loading.classList.remove('d-none');
    preview.classList.add('d-none');

    fetch('{{ url_for("api.generate_authors", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        loading.classList.add('d-none');
        btn.disabled = false;

        if (data.error) {
            preview.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
            preview.classList.remove('d-none');
            return;
        }

        const personas = data.authors || [];
        if (personas.length === 0) {
            preview.innerHTML = '<div class="alert alert-warning">No personas generated. Try again.</div>';
            preview.classList.remove('d-none');
            return;
        }

        let html = '<h6>Generated Personas (review before saving)</h6>';
        personas.forEach((p, i) => {
            html += `
            <div class="border rounded p-2 mb-2 bg-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${p.name}</strong> <small class="text-muted">— ${p.role || ''}</small>
                        <br><small>${p.short_bio || ''}</small>
                        <br><small class="text-muted">Expertise: ${(p.expertise || []).join(', ')}</small>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="saveGeneratedAuthor(${i})">Save</button>
                </div>
            </div>`;
        });
        preview.innerHTML = html;
        preview.classList.remove('d-none');

        window._generatedPersonas = personas;
    })
    .catch(err => {
        loading.classList.add('d-none');
        btn.disabled = false;
        preview.innerHTML = '<div class="alert alert-danger">Error: ' + err.message + '</div>';
        preview.classList.remove('d-none');
    });
}

function saveGeneratedAuthor(index) {
    const p = window._generatedPersonas[index];
    if (!p) return;

    fetch(_authorApiBase, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: p.name,
            slug: p.slug,
            role: p.role,
            short_bio: p.short_bio,
            bio: p.bio,
            expertise: p.expertise,
        }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Grey out the saved card
            const cards = document.querySelectorAll('#authorGenPreview .border');
            if (cards[index]) {
                cards[index].style.opacity = '0.5';
                cards[index].querySelector('button').disabled = true;
                cards[index].querySelector('button').textContent = 'Saved';
            }
            loadAuthors();
        } else {
            alert(data.error || 'Failed to save');
        }
    });
}

// Load authors on page load
loadAuthors();

// Init drag-and-drop when tab is shown (SortableJS needs visible elements)
document.querySelector('[data-bs-target="#tab-menu-order"]')?.addEventListener('shown.bs.tab', function() {
    initMenuOrder();
});
</script>
{% endblock %}
