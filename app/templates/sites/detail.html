{% extends "base.html" %}

{% block title %}{{ site.name }} — Affiliate Factory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ site.name }}</h1>
    {% set status_colors = {'draft': 'secondary', 'generating': 'info', 'generated': 'primary', 'building': 'info', 'built': 'primary', 'deploying': 'warning', 'deployed': 'success', 'failed': 'danger'} %}
    <span class="badge bg-{{ status_colors.get(site.status, 'secondary') }} fs-6" id="siteStatus">{{ site.status }}</span>
</div>

<!-- Rebuild Warning Banner (7.5) -->
{% if rebuild_needed %}
<div class="alert alert-warning d-flex align-items-center mb-4">
    <strong class="me-2">Rebuild needed:</strong>
    Content has changed since last build. Rebuild to update the static site, sitemap, and navigation.
    {% if site.status in ('generated', 'built') %}
    <form method="POST" action="{{ url_for('sites.build', site_id=site.id) }}" class="ms-3">
        <button type="submit" class="btn btn-sm btn-warning">Rebuild Now</button>
    </form>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="mb-4">
    {% set ungenerated = site.site_pages | rejectattr('is_generated') | list | length %}
    {% if site.status in ('draft', 'generated', 'built', 'deployed', 'failed') %}
    <form method="POST" action="{{ url_for('sites.generate', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-primary">
            {% if site.status == 'draft' %}Generate Content
            {% elif ungenerated %}Generate {{ ungenerated }} New Page{{ 's' if ungenerated != 1 }}
            {% else %}Regenerate All Content
            {% endif %}
        </button>
    </form>
    {% endif %}
    {% if site.status == 'generating' %}
    <button class="btn btn-info" disabled>Generating...</button>
    {% endif %}
    {% set has_content = site.site_pages | selectattr('is_generated') | list | length > 0 %}
    {% if has_content and site.status != 'generating' %}
    <form method="POST" action="{{ url_for('sites.generate_meta', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-outline-primary">Generate Meta Tags</button>
        <div class="form-check form-check-inline ms-1">
            <input class="form-check-input" type="checkbox" name="overwrite" id="metaOverwrite">
            <label class="form-check-label small text-muted" for="metaOverwrite">Overwrite existing</label>
        </div>
    </form>
    {% endif %}
    <form method="POST" action="{{ url_for('sites.build', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-success">
            {{ 'Rebuild Site' if site.built_at else 'Build Site' }}
        </button>
    </form>
    {% if site.status in ('built', 'deployed') and site.domain %}
    <form method="POST" action="{{ url_for('sites.deploy', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-warning">
            {{ 'Re-deploy' if site.status == 'deployed' else 'Deploy' }}
        </button>
    </form>
    {% endif %}
    {% if site.status == 'deployed' and site.current_version > 1 %}
    <form method="POST" action="{{ url_for('sites.rollback', site_id=site.id) }}" class="d-inline">
        <button type="submit" class="btn btn-outline-danger"
                onclick="return confirm('Roll back to the previous version?')">
            Rollback
        </button>
    </form>
    {% endif %}
    {% if site.status == 'deploying' %}
    <button class="btn btn-warning" disabled>Deploying...</button>
    {% endif %}
    {% if site.output_path %}
    <a href="{{ url_for('sites.preview', site_id=site.id) }}" target="_blank" class="btn btn-outline-info">
        Preview
    </a>
    {% endif %}
    <a href="{{ url_for('sites.add_page', site_id=site.id) }}" class="btn btn-outline-primary">
        Add Page
    </a>
    <form method="POST" action="{{ url_for('sites.delete_site', site_id=site.id) }}" class="d-inline float-end">
        <button type="submit" class="btn btn-outline-danger"
                onclick="return confirm('Permanently delete &quot;{{ site.name }}&quot; and all its pages? This cannot be undone.')">
            Delete Site
        </button>
    </form>
</div>

<!-- Progress Bar (shown during generation) -->
<div id="progressContainer" class="mb-4 {{ '' if site.status == 'generating' else 'd-none' }}">
    <div class="progress" style="height: 25px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar" style="width: 0%">
            <span id="progressText">0 / 0 pages</span>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><strong>Configuration</strong></div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr><th>GEO</th><td>{{ site.geo.name }} ({{ site.geo.code | upper }})</td></tr>
                    <tr><th>Vertical</th><td>{{ site.vertical.name }}</td></tr>
                    <tr>
                        <th>Domain</th>
                        <td>
                            {% if site.domain %}
                                {{ site.domain.domain }}
                                <span class="badge bg-{{ 'success' if site.domain.status == 'deployed' else 'info' }}">{{ site.domain.status }}</span>
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr><th>Created</th><td>{{ site.created_at.strftime('%Y-%m-%d %H:%M') if site.created_at else '' }}</td></tr>
                    <tr><th>Version</th><td>v{{ site.current_version }}</td></tr>
                    {% if site.built_at %}
                    <tr><th>Last Build</th><td>{{ site.built_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                    {% endif %}
                    {% if site.deployed_at %}
                    <tr><th>Deployed</th><td>{{ site.deployed_at.strftime('%Y-%m-%d %H:%M') }}</td></tr>
                    {% endif %}
                    <tr>
                        <th>Freshness</th>
                        <td>
                            <form method="POST" action="{{ url_for('sites.update_freshness', site_id=site.id) }}" class="d-inline">
                                <div class="input-group input-group-sm" style="max-width: 200px;">
                                    <input type="number" name="threshold" class="form-control" value="{{ site.freshness_threshold_days or 30 }}" min="1" max="365">
                                    <span class="input-group-text">days</span>
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">Set</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <!-- Domain Assignment -->
        {% if not site.domain and available_domains %}
        <div class="card mb-3">
            <div class="card-header"><strong>Assign Domain</strong></div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('sites.assign_domain', site_id=site.id) }}">
                    <div class="input-group">
                        <select name="domain_id" class="form-select" required>
                            <option value="">Select a domain...</option>
                            {% for d in available_domains %}
                            <option value="{{ d.id }}">{{ d.domain }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#brandsCollapse" role="button" aria-expanded="false" aria-controls="brandsCollapse">
                    <strong>Brands ({{ site.site_brands | length }})</strong>
                    <small class="ms-1 text-muted">&#9662;</small>
                </a>
                <div>
                    <a href="{{ url_for('sites.manage_brands', site_id=site.id) }}" class="btn btn-sm btn-outline-primary">Manage</a>
                    <a href="{{ url_for('sites.brand_overrides', site_id=site.id) }}" class="btn btn-sm btn-outline-secondary">Overrides</a>
                </div>
            </div>
            <div class="collapse" id="brandsCollapse">
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr><th>Rank</th><th>Brand</th><th>Slug</th></tr>
                        </thead>
                        <tbody>
                            {% for sb in site.site_brands | sort(attribute='rank') %}
                            <tr>
                                <td>{{ sb.rank }}</td>
                                <td>{{ sb.brand.name }}</td>
                                <td><code>{{ sb.brand.slug }}</code></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- News Article Suggestions -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <a class="text-decoration-none text-reset" data-bs-toggle="collapse" href="#newsCollapse" role="button" aria-expanded="false" aria-controls="newsCollapse">
            <strong>News Articles</strong>
            {% set news_count = site.site_pages | selectattr('page_type') | selectattr('page_type.slug', 'equalto', 'news-article') | list | length %}
            <span class="badge bg-secondary ms-1">{{ news_count }}</span>
            <small class="ms-1 text-muted">&#9662;</small>
        </a>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnSuggestNews" onclick="suggestNews()">
            Suggest 10 Articles
        </button>
    </div>
    <div class="collapse" id="newsCollapse">
        <div class="card-body">
            <p class="text-muted mb-3" id="newsIntro">
                AI-generate timely news article topics based on your site's geo and vertical. Select the best ones to add as pages.
            </p>

            <div id="newsLoading" class="d-none text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">Generating news article suggestions...</span>
            </div>

            <div id="newsError" class="alert alert-danger d-none"></div>

            <div id="newsResults" class="d-none">
                <div id="newsList" class="mb-3"></div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" id="btnAddNews" onclick="addSelectedNews()">
                        Add Selected
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllNews(true)">Select All</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllNews(false)">Select None</button>
                </div>
            </div>

            <div id="newsAdded" class="alert alert-success d-none mt-3"></div>
        </div>
    </div>
</div>

<!-- Tabs for Pages / Robots.txt -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-sitemap" type="button">
            Site Map
            <span class="badge bg-secondary ms-1">{{ site.site_pages | length }}</span>
        </button>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('sites.menu', site_id=site.id) }}">
            Menu
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('sites.cta_table_list', site_id=site.id) }}">
            CTA Tables
        </a>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-robots" type="button">
            robots.txt
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- Sitemap Tab (7.3) -->
    <div class="tab-pane fade show active" id="tab-sitemap">
        {% set generated_count = site.site_pages | selectattr('is_generated') | list | length %}
        {% set pending_count = site.site_pages | length - generated_count %}
        <p class="text-muted mb-3">
            {{ site.site_pages | length }} pages ({{ generated_count }} generated, {{ pending_count }} pending{% if stale_count %}, <strong class="text-warning">{{ stale_count }} stale</strong>{% endif %})
        </p>

        <table class="table table-sm">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Page Type</th>
                    <th>Status</th>
                    <th>Freshness</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for page in site.site_pages %}
                {% set url = page_url(page) %}
                {% set freshness = page_freshness(page) %}
                <tr>
                    <td>
                        <code>
                        {% if site.domain %}
                            https://{{ site.domain.domain }}{{ url }}
                        {% else %}
                            {{ url }}
                        {% endif %}
                        </code>
                    </td>
                    <td><span class="badge bg-secondary">{{ page.page_type.name }}</span></td>
                    <td>
                        {% if not page.is_generated %}
                            <span class="badge bg-light text-dark">Not Generated</span>
                        {% elif site.built_at and page.generated_at and page.generated_at > site.built_at %}
                            <span class="badge bg-warning text-dark">Needs Rebuild</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% elif not site.built_at %}
                            <span class="badge bg-info">Generated</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') if page.generated_at else '' }}</small>
                        {% else %}
                            <span class="badge bg-success">Built</span>
                            <small class="text-muted ms-1">{{ page.generated_at.strftime('%Y-%m-%d %H:%M') if page.generated_at else '' }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if freshness is none %}
                            <span class="text-muted">—</span>
                        {% elif freshness.stale %}
                            <span class="badge bg-danger bg-opacity-75">Stale ({{ freshness.days }}d)</span>
                        {% else %}
                            <span class="badge bg-success bg-opacity-75">Fresh ({{ freshness.days }}d)</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('sites.edit_page', site_id=site.id, page_id=page.id) }}"
                           class="btn btn-sm btn-outline-primary">Edit</a>
                        {% if page.is_generated and site.status != 'generating' %}
                        <form method="POST" action="{{ url_for('sites.regenerate_page', site_id=site.id, page_id=page.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Regenerate</button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('sites.delete_page', site_id=site.id, page_id=page.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Delete this page? This cannot be undone.')">Delete</button>
                        </form>
                        {% if page.is_generated and site.output_path %}
                        <a href="{{ url_for('sites.preview', site_id=site.id, filename=url[1:]) }}"
                           target="_blank" class="btn btn-sm btn-outline-info">Preview</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Robots.txt Tab (7.4) -->
    <div class="tab-pane fade" id="tab-robots">
        <form id="robotsForm">
            <div class="mb-3">
                <label for="robotsTxt" class="form-label">
                    {% if site.custom_robots_txt %}
                        <strong>Custom robots.txt</strong> (will be used verbatim on next build)
                    {% else %}
                        <strong>Default robots.txt</strong> (auto-generated from template)
                    {% endif %}
                </label>
                <textarea id="robotsTxt" class="form-control font-monospace" rows="10"
                >{{ site.custom_robots_txt or default_robots_txt }}</textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveRobotsTxt()">Save Custom robots.txt</button>
            {% if site.custom_robots_txt %}
            <button type="button" class="btn btn-outline-secondary" onclick="resetRobotsTxt()">Reset to Default</button>
            {% endif %}
            <small class="text-muted ms-2">Changes take effect on next build.</small>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if site.status == 'generating' %}
<script>
(function pollProgress() {
    fetch('{{ url_for("api.generation_status", site_id=site.id) }}')
        .then(r => r.json())
        .then(data => {
            const pct = data.total_pages > 0
                ? Math.round((data.generated_pages / data.total_pages) * 100)
                : 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').textContent =
                data.generated_pages + ' / ' + data.total_pages + ' pages';
            document.getElementById('siteStatus').textContent = data.status;

            if (data.status === 'generating') {
                setTimeout(pollProgress, 2000);
            } else {
                window.location.reload();
            }
        })
        .catch(() => setTimeout(pollProgress, 3000));
})();
</script>
{% endif %}
<script>
function saveRobotsTxt() {
    const content = document.getElementById('robotsTxt').value;
    fetch('{{ url_for("api.save_robots_txt", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: content})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
    });
}

function resetRobotsTxt() {
    if (!confirm('Reset to default robots.txt? Your custom version will be removed.')) return;
    fetch('{{ url_for("api.save_robots_txt", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: null})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to reset: ' + (data.error || 'Unknown error'));
        }
    });
}

/* --- News Article Suggestions --- */
let _newsSuggestions = [];

function suggestNews() {
    const btn = document.getElementById('btnSuggestNews');
    const loading = document.getElementById('newsLoading');
    const error = document.getElementById('newsError');
    const results = document.getElementById('newsResults');
    const collapse = document.getElementById('newsCollapse');

    // Expand the collapse if closed
    const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
    bsCollapse.show();

    btn.disabled = true;
    loading.classList.remove('d-none');
    error.classList.add('d-none');
    results.classList.add('d-none');

    fetch('{{ url_for("api.suggest_news", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        loading.classList.add('d-none');
        btn.disabled = false;

        if (data.error) {
            error.textContent = data.error;
            error.classList.remove('d-none');
            return;
        }

        _newsSuggestions = data.suggestions || [];
        if (_newsSuggestions.length === 0) {
            error.textContent = 'No suggestions returned. Try again.';
            error.classList.remove('d-none');
            return;
        }

        const list = document.getElementById('newsList');
        list.innerHTML = '';
        _newsSuggestions.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2 p-2 border rounded';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" id="news-${i}" checked>
                <label class="form-check-label" for="news-${i}">
                    <strong>${s.topic}</strong>
                    <br><small class="text-muted">${s.angle || ''}</small>
                    <br><small class="text-info">${s.reason || ''}</small>
                </label>
            `;
            list.appendChild(div);
        });

        results.classList.remove('d-none');
    })
    .catch(err => {
        loading.classList.add('d-none');
        btn.disabled = false;
        error.textContent = 'Request failed: ' + err.message;
        error.classList.remove('d-none');
    });
}

function toggleAllNews(checked) {
    document.querySelectorAll('#newsList input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
    });
}

function addSelectedNews() {
    const pages = [];
    const checkboxes = document.querySelectorAll('#newsList input[type="checkbox"]');
    checkboxes.forEach((cb, i) => {
        if (cb.checked && _newsSuggestions[i]) {
            pages.push({
                page_type: 'news-article',
                evergreen_topic: _newsSuggestions[i].topic,
            });
        }
    });

    if (pages.length === 0) {
        alert('Select at least one article to add.');
        return;
    }

    // Auto-include news landing page if not already present
    {% set has_news_landing = site.site_pages | selectattr('page_type') | selectattr('page_type.slug', 'equalto', 'news') | list | length > 0 %}
    {% if not has_news_landing %}
    pages.unshift({page_type: 'news'});
    {% endif %}

    const btn = document.getElementById('btnAddNews');
    btn.disabled = true;
    btn.textContent = 'Adding...';

    fetch('{{ url_for("sites.add_suggested_pages", site_id=site.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pages: pages}),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = 'Add Selected';

        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        const msg = document.getElementById('newsAdded');
        msg.textContent = `Added ${data.added} page(s)` + (data.skipped ? ` (${data.skipped} skipped)` : '') + '. Reloading...';
        msg.classList.remove('d-none');
        document.getElementById('newsResults').classList.add('d-none');

        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Add Selected';
        alert('Request failed: ' + err.message);
    });
}
</script>
{% endblock %}
